{% extends 'Base/base.html' %}
{% block title %}Dashboard Explorador{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='Estilos/login.css') }}">

<div class="dashboard">
  <!-- ===== SIDEBAR IZQUIERDA ===== -->
  <div class="sidebar">
    <div class="brand">
      <img src="{{ url_for('static', filename='Imagenes/LogoSencillo.png') }}" alt="Logo">
      <h2>Panel Explorador</h2>
      <p class="welcome-text">Bienvenido, {{ user.username }}</p>
    </div>

    <a href="#" class="sidebar-btn active" data-section="descubrir">Descubrir lugares</a>
    <a href="#" class="sidebar-btn" data-section="favoritos">Mis favoritos</a>
    <a href="#" class="sidebar-btn" data-section="actividad">Actividad</a>
    <a href="#" class="sidebar-btn" data-section="perfil">Mi perfil</a>
    <a href="{{ url_for('logout') }}">Cerrar sesi√≥n</a>
  </div>

  <!-- ===== CONTENIDO PRINCIPAL ===== -->
  <div class="main-content">
    <h1 id="section-title">Descubrir lugares</h1>

  <!-- === SECCI√ìN DESCUBRIR === -->
  <div id="descubrir" class="content-section active">
    <div class="content-card pastel-sky">
      <h1 class="main-title">üß≠ Buscador de Myiana</h1>
      <h3 class="subtitle">¬øQu√© te gustar√≠a descubrir hoy?</h3>
      <p>Elige una categor√≠a para recibir una recomendaci√≥n especial.</p>

      <!-- Botones de categor√≠as -->
      <div class="category-buttons">
        <button class="btn btn-primary" onclick="recomendarLugar('comida')">üçΩÔ∏è Comida</button>
        <button class="btn btn-primary" onclick="recomendarLugar('naturaleza')">üå≥ Naturaleza</button>
        <button class="btn btn-primary" onclick="recomendarLugar('cultura')">üé® Arte y Cultura</button>
        <button class="btn btn-primary" onclick="recomendarLugar('deporte')">‚öΩ Deportes</button>
        <button class="btn btn-primary" onclick="recomendarLugar('compras')">üõçÔ∏è Compras</button>
        <button class="btn btn-primary" onclick="recomendarLugar('tecnologia')">üíª Tecnolog√≠a</button>
      </div>

      <!-- Resultado aleatorio -->
      <div id="recomendacion-aleatoria" class="grid-lugares" style="margin-top: 25px;"></div>
    </div>

  </div>

    <!-- === SECCI√ìN FAVORITOS (actualizada) === -->
    <div id="favoritos" class="content-section">
      <div class="content-card pastel-lavender">
        <h2>Mis lugares favoritos</h2>

        {% if favoritos %}
          <table class="data-table wide">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Categor√≠a</th>
                <th>Guardado el</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for fav in favoritos %}
              <tr>
                <td>{{ fav.empresa.nombre_emprendimiento  }}</td>
                <td>{{ fav.empresa.clasificacion }}</td>
                <td>{{ fav.fecha_guardado.strftime('%d/%m/%Y') }}</td>
                <td>
                  <a href="{{ fav.empresa.url or '#' }}" method="post" style="display:inline;">
                    <button type="submit" class="btn small btn-secondary">Visitar</button>
                  </a>
                <form action="{{ url_for('eliminar_favorito', fav_id=fav.id) }}" method="post" style="display:inline;">
                  <button type="submit" class="btn small btn-secondary">Eliminar</button>
                </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No tienes lugares guardados como favoritos todav√≠a.</p>
        {% endif %}
      </div>
    </div>

    <!-- === SECCI√ìN ACTIVIDAD === -->
    <div id="actividad" class="content-section">
      <div class="content-card pastel-green">
        <h2>Historial de actividad</h2>
        <p>Consulta tus visitas recientes y el tiempo invertido explorando lugares de Ch√≠a.</p>
        <canvas id="graficoActividad"></canvas>
      </div>

      <div class="content-card pastel-sun">
        <h3>Resumen de la semana</h3>
        <ul>
          <li><strong>Visitas totales:</strong> 14</li>
          <li><strong>Lugar m√°s visitado:</strong> Centro Ch√≠a</li>
          <li><strong>D√≠a con m√°s actividad:</strong> S√°bado</li>
        </ul>
      </div>
    </div>

    <!-- === SECCI√ìN PERFIL === -->
    <div id="perfil" class="content-section">
      <div class="content-card pastel-blue">
        <h2>Mi perfil</h2>
        <p><strong>Nombre:</strong> {{ user.username }}</p>
        <p><strong>Correo:</strong> {{ user.email }}</p>
        <p><strong>Miembro desde:</strong> {{ user.fecha_registro }}</p>
        <button class="btn btn-primary">Editar perfil</button>
      </div>

      <div class="content-card pastel-pink">
        <h3>Preferencias</h3>
        <p>Selecciona tus intereses para obtener mejores recomendaciones:</p>
        <form>
          <label><input type="checkbox" checked> Gastronom√≠a</label><br>
          <label><input type="checkbox"> Entretenimiento</label><br>
          <label><input type="checkbox"> Cultura</label><br>
          <label><input type="checkbox"> Naturaleza</label><br>
          <button class="btn btn-primary" type="submit">Guardar cambios</button>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- === SCRIPT PARA CAMBIAR SECCIONES === -->
<script>
  document.querySelectorAll('.sidebar-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const section = btn.dataset.section;
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(section).classList.add('active');

      const title = document.getElementById('section-title');
      if (section === 'descubrir') title.textContent = 'Descubrir lugares';
      else if (section === 'favoritos') title.textContent = 'Mis lugares favoritos';
      else if (section === 'actividad') title.textContent = 'Mi actividad';
      else title.textContent = 'Perfil de explorador';
    });
  });
</script>

<!-- === CHART.JS PARA LA GR√ÅFICA DE ACTIVIDAD === -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('graficoActividad');
  if (ctx) {
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
        datasets: [{
          label: 'Visitas por d√≠a',
          data: [2, 3, 1, 4, 2, 5, 3],
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>

<!-- === SCRIPT DE RECOMENDACIONES ALEATORIAS === -->
<script>
  const exploradorId = {{ explorador.id }}; // Asumiendo que lo pasas desde Flask

  // --- Cargar recomendaciones personalizadas ---
  fetch(`/recomendaciones/${exploradorId}`)
    .then(res => res.json())
    .then(data => {
      const contenedor = document.getElementById('recomendaciones-personalizadas');
      if (!data.length) {
        contenedor.innerHTML = `<p>No hay recomendaciones personalizadas a√∫n. ¬°Explora m√°s lugares!</p>`;
        return;
      }

      contenedor.innerHTML = data.map(lugar => `
        <div class="store-card">
          <img src="${lugar.imagen_filename}" class="img-uniforme">
          <h3>${lugar.nombre}</h3>
          <p>${lugar.descripcion}</p>
          <a href="${lugar.url}" target="_blank" class="btn btn-primary">Visitar</a>
        </div>
      `).join('');
    });

  // --- Recomendaci√≥n por categor√≠a ---
  function recomendarLugar(categoria) {
    fetch(`/recomendar/${categoria}`)
      .then(res => res.json())
      .then(lugar => {
        const contenedor = document.getElementById('recomendacion-aleatoria');
        if (lugar.error) {
          contenedor.innerHTML = `<p>No hay lugares en esta categor√≠a a√∫n.</p>`;
          return;
        }
        contenedor.innerHTML = `
          <div class="store-card">
            <img src="${lugar.imagen}" alt="${lugar.nombre}" class="img-uniforme">
            <h3>${lugar.nombre}</h3>
            <p>${lugar.descripcion}</p>
            <a href="${lugar.url}" target="_blank" class="btn btn-primary">Visitar</a>
          </div>
        `;
      });
  }
</script>
{% endblock %}



